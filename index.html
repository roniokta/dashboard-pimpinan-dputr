<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Pimpinan DPUTR Kab. Bandung</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Animate.css CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --card-w: 240px; --card-h: 160px; }
    body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }

    /* ðŸ”¹ Header background gradient animasi */
    .header-bg {
      background: linear-gradient(-45deg, #2563eb, #4338ca, #3b82f6, #6366f1);
      background-size: 400% 400%;
      animation: gradientShift 18s ease infinite;
      height: 100vh;
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .wave { position: absolute; bottom: -1px; left: 0; width: 200%; height: 120px; background: url('https://svgshare.com/i/uUu.svg') repeat-x; background-size: 50% 120px; animation: waveMove 8s linear infinite; opacity: 0.9; z-index: 5; }
    @keyframes waveMove { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    /* ðŸ”¹ Kartu menu */
    .dashboard-card {
      width: var(--card-w); height: var(--card-h);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; padding: 1rem; border-radius: 18px;
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden;
    }
    .dashboard-card:hover { transform: translateY(-6px) scale(1.04); box-shadow: 0 12px 28px rgba(0,0,0,0.18); }
    .dashboard-card .card-img { width: 72px; height: 72px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.25)); transition: transform 0.3s ease; }
    .dashboard-card:hover .card-img { transform: scale(1.1) rotate(3deg); }

  </style>

  <!-- Helper sanitasi -->
  <script>
    const ALLOWED_URL_RE=/^(https?:|mailto:|tel:)/i;
    function sanitizeText(v,max=5000){if(v==null)return'';v=String(v).replace(/[\u0000-\u001F\u007F]/g,'');v=v.replace(/<\s*\/?\s*script\b[^>]*>/gi,'');if(/^[=+\-@]/.test(v))v="'"+v;return v.trim().slice(0,max);}
    function escapeHTML(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
    function safeURL(u){const s=String(u||'').trim();return ALLOWED_URL_RE.test(s)?s:'#';}
    function setText(el,v){el.textContent=sanitizeText(v);}
  </script>
</head>

<body class="bg-gradient-to-r from-green-200 via-blue-200 to-purple-200 min-h-screen flex flex-col items-center justify-start">

  <!-- HEADER -->
  <div class="header-bg w-full relative">
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="relative flex flex-col lg:flex-row items-center justify-center gap-6 px-6 text-center lg:text-left z-10">
      <div class="flex flex-col items-center lg:items-start animate__animated animate__fadeInLeft">
        <img src="assets/kepala-dinas.jpg" alt="Kepala Dinas" class="w-32 h-32 sm:w-40 sm:h-40 md:w-48 md:h-48 rounded-full border-4 border-white shadow-xl bg-white object-contain"/>
        <p class="mt-3 text-lg md:text-2xl font-bold text-white drop-shadow-lg border-b-2 border-white pb-1">
          Dr. Ir. H. Zeis Zultaqawa, M.M., IPU, ASEAN ENG.
        </p>
        <p class="text-sm md:text-lg text-white drop-shadow-lg mt-1">Kepala Dinas</p>
      </div>
      <h1 class="max-w-[700px] text-2xl md:text-5xl font-extrabold text-white drop-shadow-lg leading-snug animate__animated animate__fadeInDown">
        DASHBOARD PROGRES KEGIATAN<br class="hidden md:block">DPUTR KABUPATEN BANDUNG
      </h1>
    </div>
    <div class="wave"></div>
  </div>

  <!-- REKAP DINAS + CHART -->
  <div class="w-full max-w-7xl px-4 sm:px-6 -mt-10 mb-10">
    <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-lg p-6">
      <h2 class="text-xl md:text-2xl font-bold text-teal-700 mb-6 text-center">ðŸ“Š Rekap Dinas & Tren Prognosis (Septâ€“Nov 2025)</h2>
      <div id="rekap-cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-10"></div>
      <div class="bg-white/80 rounded-2xl shadow p-4">
        <h3 class="text-center text-teal-700 font-semibold mb-3">ðŸ“ˆ Tren Prognosis</h3>
        <canvas id="prognosisChartTop"></canvas>
      </div>
    </div>
  </div>

  <!-- DASHBOARD PROGRES -->
  <div class="w-full max-w-[1500px] xl:max-w-[1600px] px-4 sm:px-6 mt-6 mb-6">
    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center">ðŸ“Š Progres Kegiatan Per Unit Kerja DPUTR TA 2025</h2>
    <div id="dashboard" class="space-y-10"></div>
  </div>

  <!-- ====== SCRIPT REKAP DINAS ====== -->
  <script>
    (function(){
      const CSV_REKAP_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSvrgVrpTFMrG-NDpW9HUzpmSvFVOFH-k2o4C9cOp3XwC-EtJaiCL1T5Y4nBgLeaDw-gTJS8O3q1EHd/pub?gid=1853757195&single=true&output=csv";
      const fIDR=n=>isNaN(n)?'-':new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n);
      const fInt=n=>isNaN(n)?'-':new Intl.NumberFormat('id-ID').format(n);
      const fPct=n=>isNaN(n)?'-':`${(+n).toFixed(2)}%`;
      const toNum=s=>parseFloat(String(s||'').replace(/\./g,'').replace(/,/g,'.'))||0;

      function card(title,main,sub,prog,color="teal"){
        const bar=color==="green"?"bg-green-500":color==="cyan"?"bg-cyan-500":color==="lime"?"bg-lime-500":"bg-teal-500";
        const hasProg=prog!==undefined&&!isNaN(prog);
        return `<div class="bg-white/90 border border-teal-100 p-4 rounded-2xl shadow text-center">
          <h2 class="text-sm font-semibold mb-2 text-gray-600">${title}</h2>
          <p class="text-xl font-bold text-teal-700">${main}</p>
          ${sub?`<p class="mt-1 text-sm text-gray-500">${sub}</p>`:''}
          ${hasProg?`<div class="w-full bg-gray-200 rounded-full h-2 mt-2"><div class="${bar} h-2 rounded-full" style="width:${prog}%;"></div></div>`:''}
        </div>`;
      }

      function parseCSV(text){const rows=[];let cur="",row=[],inQ=false;for(let i=0;i<text.length;i++){const ch=text[i],n=text[i+1];if(inQ){if(ch==='"'&&n==='"'){cur+='"';i++;}else if(ch==='"'){inQ=false;}else cur+=ch;}else{if(ch==='"'){inQ=true;}else if(ch===','){row.push(cur);cur="";}else if(ch==='\n'){row.push(cur);rows.push(row);row=[];cur="";}else if(ch!=='\r'){cur+=ch;}}}row.push(cur);rows.push(row);return rows;}

      function render(d){
        const wrap=document.getElementById('rekap-cards');
        wrap.innerHTML=`
          ${card("Total Paket",fInt(d.totalPaket))}
          ${card("Total Anggaran",fIDR(d.totalAnggaran))}
          ${card("Selesai",fInt(d.selesai),fPct(d.pctPaketSelesai),d.pctPaketSelesai,"green")}
          ${card("Nilai Kontrak (selesai)",fIDR(d.nilaiKontrakSelesai),fPct(d.pctNilaiKontrakSelesai),d.pctNilaiKontrakSelesai,"teal")}
          ${card("Prognosis 30 Sept 2025",fIDR(d.prognosisSept),fPct(d.pctPrognosisSept),d.pctPrognosisSept,"cyan")}
          ${card("Prognosis 30 Nov 2025",fIDR(d.prognosisNov),fPct(d.pctPrognosisNov),d.pctPrognosisNov,"green")}
        `;
        const ctx=document.getElementById('prognosisChartTop')?.getContext('2d');
        if(!ctx)return;
        new Chart(ctx,{type:'line',data:{labels:["30 Sept","31 Okt","30 Nov"],datasets:[{label:'Nilai Prognosis',data:[d.prognosisSept,d.prognosisOkt,d.prognosisNov],borderColor:'#14b8a6',backgroundColor:'rgba(20,184,166,0.15)',borderWidth:3,pointBackgroundColor:'#0d9488',pointRadius:6,tension:0.3}]},options:{responsive:true,plugins:{legend:{labels:{color:'#0f766e'}}},scales:{x:{ticks:{color:'#0f766e'}},y:{ticks:{color:'#0f766e',callback:v=>fIDR(v)}}}}});
      }

      async function fetchRekap(){
        const res=await fetch(CSV_REKAP_URL);const text=await res.text();const rows=parseCSV(text.trim());
        const d=rows[1]||[];
        const totalPaket=toNum(d[0]),totalAnggaran=toNum(d[1]),selesai=toNum(d[11]),nilaiKontrakSelesai=toNum(d[12]),prognosisSept=toNum(d[13]),prognosisOkt=toNum(d[14]),prognosisNov=toNum(d[15]);
        render({totalPaket,totalAnggaran,selesai,nilaiKontrakSelesai,prognosisSept,prognosisOkt,prognosisNov,pctPaketSelesai:totalPaket?(selesai/totalPaket*100):0,pctNilaiKontrakSelesai:totalAnggaran?(nilaiKontrakSelesai/totalAnggaran*100):0,pctPrognosisSept:totalAnggaran?(prognosisSept/totalAnggaran*100):0,pctPrognosisNov:totalAnggaran?(prognosisNov/totalAnggaran*100):0});
      }
      document.addEventListener('DOMContentLoaded',fetchRekap);
    })();
  </script>

  <!-- ====== SCRIPT DASHBOARD PER BIDANG ====== -->
  <script>
    const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vSvrgVrpTFMrG-NDpW9HUzpmSvFVOFH-k2o4C9cOp3XwC-EtJaiCL1T5Y4nBgLeaDw-gTJS8O3q1EHd/pub?gid=1875135079&single=true&output=csv";

    function parseCSV(text){const rows=[];let cur="",row=[],inQ=false;for(let i=0;i<text.length;i++){const ch=text[i],n=text[i+1];if(inQ){if(ch==='"'&&n==='"'){cur+='"';i++;}else if(ch==='"'){inQ=false;}else cur+=ch;}else{if(ch==='"'){inQ=true;}else if(ch===','){row.push(cur);cur="";}else if(ch==='\n'){row.push(cur);rows.push(row);row=[];cur="";}else if(ch!=='\r'){cur+=ch;}}}row.push(cur);rows.push(row);return rows;}

    // ðŸ”§ fungsi toNum yang lebih kuat
    function toNum(v){if(v==null)return 0;let s=String(v).trim();if(!s)return 0;s=s.replace(/[^\d,.-]/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',', '.');const n=parseFloat(s);return isNaN(n)?0:n;}
    const persen=(a,b)=>b>0?Math.round((a/b)*1000)/10:0;
    const rupiah=v=>"Rp "+toNum(v).toLocaleString('id-ID');

    function renderDashboard(data){
      const container=document.getElementById("dashboard");
      container.innerHTML="";
      data.forEach(row=>{
        const unit=sanitizeText(row[0]);if(!unit)return;
        const jumlah=toNum(row[1]),pagu=toNum(row[2]),
          persiapan=toNum(row[3]),nilaiPersiapan=toNum(row[4]),
          berkontrak=toNum(row[5]),nilaiBerkontrak=toNum(row[6]),
          selesai=toNum(row[7]),nilaiSelesai=toNum(row[8]);

        const card=document.createElement("div");
        card.className="bg-white shadow-lg rounded-xl p-6 w-full";
        card.innerHTML=`
          <h2 class="text-2xl font-bold text-indigo-600 mb-2">${unit}</h2>
          <p class="text-sm text-gray-600">Jumlah Total Paket: <span class="font-semibold">${jumlah}</span></p>
          <p class="text-sm text-gray-600 mb-4">Total Pagu Anggaran: <span class="font-semibold">${rupiah(pagu)}</span></p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-4 rounded-lg border bg-indigo-50">
              <h3 class="font-semibold text-lg mb-2">Persiapan</h3>
              <p class="text-2xl font-bold text-indigo-700">${persiapan}</p>
              <p class="text-gray-600">(${persen(persiapan,jumlah)}% paket)</p>
              <p class="text-sm text-gray-500">${rupiah(nilaiPersiapan)} (${persen(nilaiPersiapan,pagu)}% pagu)</p>
            </div>
            <div class="p-4 rounded-lg border bg-green-50">
              <h3 class="font-semibold text-lg mb-2">Berkontrak</h3>
              <p class="text-2xl font-bold text-green-700">${berkontrak}</p>
              <p class="text-gray-600">(${persen(berkontrak,jumlah)}% paket)</p>
              <p class="text-sm text-gray-500">${rupiah(nilaiBerkontrak)} (${persen(nilaiBerkontrak,pagu)}% pagu)</p>
            </div>
            <div class="p-4 rounded-lg border bg-blue-50">
              <h3 class="font-semibold text-lg mb-2">Selesai</h3>
              <p class="text-2xl font-bold text-blue-700">${selesai}</p>
              <p class="text-gray-600">(${persen(selesai,jumlah)}% paket)</p>
              <p class="text-sm text-gray-500">${rupiah(nilaiSelesai)} (${persen(nilaiSelesai,pagu)}% pagu)</p>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    async function fetchData(){const res=await fetch(safeURL(csvUrl));const text=await res.text();const rows=parseCSV(text.trim());renderDashboard(rows.slice(1));}
    document.addEventListener('DOMContentLoaded',fetchData);
  </script>

  <!-- FOOTER -->
  <footer class="mt-12 w-full bg-black/40 backdrop-blur-sm py-4 shadow-inner text-white text-center">
    Â© <span id="year"></span> Dinas Pekerjaan Umum dan Tata Ruang â€“ Kabupaten Bandung
  </footer>
  <script>document.getElementById("year").textContent=new Date().getFullYear();</script>

</body>
</html>
